<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–í–µ–±-—Ñ–æ—Ä—É–º</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>–í–µ–±-—Ñ–æ—Ä—É–º</h1>
            <p class="subtitle">Pair of anonymous imageboards <span id="ws-status" class="ws-status"></span></p>
        </header>

        <div class="boards-list">
            <div class="boards-header">
                <h2>–î–æ—Å–∫–∏</h2>
                <div class="boards-controls">
                    <input type="text" id="board-search" placeholder="–ü–æ–∏—Å–∫ –¥–æ—Å–æ–∫..." class="search-input">
                    <button class="btn" onclick="openModal()">+ –°–æ–∑–¥–∞—Ç—å –¥–æ—Å–∫—É</button>
                </div>
            </div>

            <div class="boards-container" id="boards-container">
                {{range .Boards}}
                <div class="board-item" id="board-{{.ID}}" data-name="{{.Name}}" data-id="{{.ID}}" data-desc="{{.Description}}">
                    <h3><a href="/board/{{.ID}}">/{{.ID}}/ - {{.Name}}</a></h3>
                    <p>{{.Description}}</p>
                    <p class="stats">–¢—Ä–µ–¥–æ–≤: {{.ThreadCount}}</p>
                </div>
                {{else}}
                <p class="no-content" id="no-boards">–ü–æ–∫–∞ –Ω–µ—Ç –¥–æ—Å–æ–∫. –°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—É—é!</p>
                {{end}}
            </div>
        </div>

        <footer>
            <p>–í–µ–±-—Ñ–æ—Ä—É–º &copy; 2025</p>
        </footer>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ -->
    <div class="modal-overlay" id="modal-overlay" onclick="closeModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2>–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –¥–æ—Å–∫—É</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <form action="/api/board" method="POST" id="create-board-form">
                <div class="form-group">
                    <label>ID –¥–æ—Å–∫–∏:</label>
                    <input type="text" name="id" id="board-id" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: b, pr, tech" required pattern="[a-z0-9]+" title="–¢–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω—Å–∫–∏–µ –±—É–∫–≤—ã –∏ —Ü–∏—Ñ—Ä—ã">
                </div>
                <div class="form-group">
                    <label>–ù–∞–∑–≤–∞–Ω–∏–µ:</label>
                    <input type="text" name="name" id="board-name" placeholder="Random" required>
                </div>
                <div class="form-group">
                    <label>–û–ø–∏—Å–∞–Ω–∏–µ:</label>
                    <input type="text" name="description" id="board-desc" placeholder="Pair of random topics">
                </div>
                <div class="form-buttons">
                    <button type="submit" class="btn">–°–æ–∑–¥–∞—Ç—å –¥–æ—Å–∫—É</button>
                    <button type="button" class="btn btn-cancel" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let ws;
        let reconnectInterval;

        // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WebSocket –¥–ª—è –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = protocol + '//' + window.location.host + '/ws/home';

            ws = new WebSocket(wsUrl);

            ws.onopen = function() {
                console.log('WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω');
                document.getElementById('ws-status').textContent = 'üü¢ Live';
                document.getElementById('ws-status').style.color = '#117743';
                if (reconnectInterval) {
                    clearInterval(reconnectInterval);
                    reconnectInterval = null;
                }
            };

            ws.onmessage = function(event) {
                const msg = JSON.parse(event.data);
                console.log('–ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ:', msg);

                if (msg.type === 'new_board') {
                    addNewBoard(msg.data);
                }
            };

            ws.onclose = function() {
                console.log('WebSocket –æ—Ç–∫–ª—é—á–µ–Ω');
                document.getElementById('ws-status').textContent = 'üî¥ Offline';
                document.getElementById('ws-status').style.color = '#af0a0f';

                if (!reconnectInterval) {
                    reconnectInterval = setInterval(function() {
                        console.log('–ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...');
                        connectWebSocket();
                    }, 3000);
                }
            };

            ws.onerror = function(error) {
                console.error('WebSocket –æ—à–∏–±–∫–∞:', error);
            };
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π –¥–æ—Å–∫–∏
        function addNewBoard(boardData) {
            const container = document.getElementById('boards-container');

            // –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ "–Ω–µ—Ç –¥–æ—Å–æ–∫"
            const noBoards = document.getElementById('no-boards');
            if (noBoards) {
                noBoards.remove();
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ—Ç –ª–∏ —É–∂–µ —ç—Ç–æ–π –¥–æ—Å–∫–∏
            if (document.getElementById('board-' + boardData.id)) {
                return;
            }

            const boardHtml = `
                <div class="board-item new-board" id="board-${boardData.id}" data-name="${escapeHtml(boardData.name)}" data-id="${boardData.id}" data-desc="${escapeHtml(boardData.description || '')}">
                    <h3><a href="/board/${boardData.id}">/${boardData.id}/ - ${escapeHtml(boardData.name)}</a></h3>
                    <p>${escapeHtml(boardData.description || '')}</p>
                    <p class="stats">–¢—Ä–µ–¥–æ–≤: <span class="thread-count">0</span></p>
                </div>`;

            container.insertAdjacentHTML('afterbegin', boardHtml);

            // –ê–Ω–∏–º–∞—Ü–∏—è
            setTimeout(() => {
                const newBoard = document.getElementById('board-' + boardData.id);
                if (newBoard) {
                    newBoard.classList.remove('new-board');
                }
            }, 2000);
        }

        // –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ HTML
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // –ü–æ–∏—Å–∫ –¥–æ—Å–æ–∫
        document.getElementById('board-search').addEventListener('input', function() {
            const query = this.value.toLowerCase();
            const boards = document.querySelectorAll('.board-item');

            boards.forEach(board => {
                const name = board.dataset.name.toLowerCase();
                const id = board.dataset.id.toLowerCase();
                const desc = board.dataset.desc.toLowerCase();

                if (name.includes(query) || id.includes(query) || desc.includes(query)) {
                    board.style.display = 'block';
                } else {
                    board.style.display = 'none';
                }
            });
        });

        // –û—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        function openModal() {
            document.getElementById('modal-overlay').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        // –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        function closeModal(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('modal-overlay').classList.remove('active');
            document.body.style.overflow = '';
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ Escape
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeModal();
            }
        });

        // –ó–∞–ø—É—Å–∫ WebSocket
        connectWebSocket();
    </script>
</body>
</html>
