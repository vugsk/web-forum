<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.Title}} - /{{.BoardID}}/</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <div class="nav">
            [<a href="/">–ì–ª–∞–≤–Ω–∞—è</a>] [<a href="/board/{{.BoardID}}">/{{.BoardID}}/</a>] [<a href="#reply-form">–û—Ç–≤–µ—Ç–∏—Ç—å</a>] [<a href="/thread/{{.ThreadID}}">–û–±–Ω–æ–≤–∏—Ç—å</a>]
            <span id="ws-status" class="ws-status"></span>
        </div>

        <header>
            <h1>{{.Title}}</h1>
            <p class="subtitle">/{{.BoardID}}/</p>
        </header>

        <div class="thread-posts" id="thread-posts">
            {{range $index, $post := .Posts}}
            <div class="post {{if eq $index 0}}op-post{{end}}" id="post-{{$post.ID}}" style="margin-left: {{multiply $post.Depth 20}}px;" data-depth="{{$post.Depth}}">
                <div class="post-header">
                    <span class="post-author">{{$post.Author}}</span>
                    <span class="post-date">{{formatTime $post.CreatedAt}}</span>
                    <span class="post-id">No.<a href="#post-{{$post.ID}}">{{$post.ID}}</a></span>
                    {{if $post.ParentID.Valid}}
                    <span class="reply-to">&gt;&gt;<a href="#post-{{nullInt $post.ParentID}}">{{nullInt $post.ParentID}}</a></span>
                    {{end}}
                    <button class="reply-btn" onclick="setReplyTo({{$post.ID}})">[–û—Ç–≤–µ—Ç–∏—Ç—å]</button>
                </div>

                {{if $post.MediaPath.Valid}}
                <div class="post-media">
                    {{if eq (nullStr $post.MediaType) "image"}}
                    <a href="{{nullStr $post.MediaPath}}" target="_blank">
                        <img src="{{nullStr $post.MediaPath}}" alt="Image" class="media-image">
                    </a>
                    {{else if eq (nullStr $post.MediaType) "video"}}
                    <video controls class="media-video">
                        <source src="{{nullStr $post.MediaPath}}">
                        –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–∏–¥–µ–æ.
                    </video>
                    {{else if eq (nullStr $post.MediaType) "audio"}}
                    <audio controls class="media-audio">
                        <source src="{{nullStr $post.MediaPath}}">
                        –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∞—É–¥–∏–æ.
                    </audio>
                    {{end}}
                </div>
                {{end}}

                <div class="post-content">
                    <p>{{$post.Content}}</p>
                </div>
            </div>
            {{end}}
        </div>

        <div class="reply-form" id="reply-form">
            <h2>–û—Ç–≤–µ—Ç–∏—Ç—å –≤ —Ç—Ä–µ–¥</h2>
            <form action="/api/post" method="POST" enctype="multipart/form-data" id="post-form">
                <input type="hidden" name="thread_id" value="{{.ThreadID}}">
                <input type="hidden" name="parent_id" id="parent_id" value="0">

                <div class="form-group reply-info" id="reply-info" style="display: none;">
                    <span>–û—Ç–≤–µ—Ç –Ω–∞ –ø–æ—Å—Ç: <strong id="reply-to-id"></strong></span>
                    <button type="button" onclick="clearReply()">[X]</button>
                </div>

                <div class="form-group">
                    <label>–ò–º—è:</label>
                    <input type="text" name="author" placeholder="–ê–Ω–æ–Ω–∏–º">
                </div>
                <div class="form-group">
                    <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</label>
                    <textarea name="content" placeholder="–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è..." required rows="5"></textarea>
                </div>
                <div class="form-group">
                    <label>–§–∞–π–ª:</label>
                    <input type="file" name="media" accept="image/*,video/*,audio/*">
                    <span class="file-hint">–ú–∞–∫—Å. 100MB. –§–æ—Ä–º–∞—Ç—ã: JPG, PNG, GIF, WEBM, MP4, MP3</span>
                </div>
                <button type="submit" class="btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </form>
        </div>

        <footer>
            [<a href="/">–ì–ª–∞–≤–Ω–∞—è</a>] [<a href="/board/{{.BoardID}}">/{{.BoardID}}/</a>] [<a href="#">–ù–∞–≤–µ—Ä—Ö</a>]
        </footer>
    </div>

    <script>
        const threadID = {{.ThreadID}};
        let ws;
        let reconnectInterval;

        // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WebSocket
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = protocol + '//' + window.location.host + '/ws/thread?thread_id=' + threadID;

            ws = new WebSocket(wsUrl);

            ws.onopen = function() {
                console.log('WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω');
                document.getElementById('ws-status').textContent = 'üü¢ Live';
                document.getElementById('ws-status').style.color = '#117743';
                if (reconnectInterval) {
                    clearInterval(reconnectInterval);
                    reconnectInterval = null;
                }
            };

            ws.onmessage = function(event) {
                const msg = JSON.parse(event.data);
                console.log('–ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ:', msg);

                if (msg.type === 'new_post') {
                    addNewPost(msg.data);
                }
            };

            ws.onclose = function() {
                console.log('WebSocket –æ—Ç–∫–ª—é—á–µ–Ω');
                document.getElementById('ws-status').textContent = 'üî¥ Offline';
                document.getElementById('ws-status').style.color = '#af0a0f';

                // –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
                if (!reconnectInterval) {
                    reconnectInterval = setInterval(function() {
                        console.log('–ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...');
                        connectWebSocket();
                    }, 3000);
                }
            };

            ws.onerror = function(error) {
                console.error('WebSocket –æ—à–∏–±–∫–∞:', error);
            };
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–æ—Å—Ç–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É
        function addNewPost(postData) {
            const postsContainer = document.getElementById('thread-posts');

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ—Ç –ª–∏ —É–∂–µ —ç—Ç–æ–≥–æ –ø–æ—Å—Ç–∞
            if (document.getElementById('post-' + postData.id)) {
                return;
            }

            // –í—ã—á–∏—Å–ª—è–µ–º –æ—Ç—Å—Ç—É–ø
            let depth = 0;
            if (postData.parent_id > 0) {
                const parentPost = document.getElementById('post-' + postData.parent_id);
                if (parentPost) {
                    depth = parseInt(parentPost.dataset.depth || 0) + 1;
                }
            }

            // –°–æ–∑–¥–∞—ë–º HTML –ø–æ—Å—Ç–∞
            let mediaHtml = '';
            if (postData.media_path) {
                if (postData.media_type === 'image') {
                    mediaHtml = `
                        <div class="post-media">
                            <a href="${postData.media_path}" target="_blank">
                                <img src="${postData.media_path}" alt="Image" class="media-image">
                            </a>
                        </div>`;
                } else if (postData.media_type === 'video') {
                    mediaHtml = `
                        <div class="post-media">
                            <video controls class="media-video">
                                <source src="${postData.media_path}">
                            </video>
                        </div>`;
                } else if (postData.media_type === 'audio') {
                    mediaHtml = `
                        <div class="post-media">
                            <audio controls class="media-audio">
                                <source src="${postData.media_path}">
                            </audio>
                        </div>`;
                }
            }

            let replyToHtml = '';
            if (postData.parent_id > 0) {
                replyToHtml = `<span class="reply-to">&gt;&gt;<a href="#post-${postData.parent_id}">${postData.parent_id}</a></span>`;
            }

            const postHtml = `
                <div class="post new-post" id="post-${postData.id}" style="margin-left: ${depth * 20}px;" data-depth="${depth}">
                    <div class="post-header">
                        <span class="post-author">${escapeHtml(postData.author)}</span>
                        <span class="post-date">${postData.created_at}</span>
                        <span class="post-id">No.<a href="#post-${postData.id}">${postData.id}</a></span>
                        ${replyToHtml}
                        <button class="reply-btn" onclick="setReplyTo(${postData.id})">[–û—Ç–≤–µ—Ç–∏—Ç—å]</button>
                    </div>
                    ${mediaHtml}
                    <div class="post-content">
                        <p>${escapeHtml(postData.content)}</p>
                    </div>
                </div>`;

            // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ—Å—Ç
            postsContainer.insertAdjacentHTML('beforeend', postHtml);

            // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è
            const newPost = document.getElementById('post-' + postData.id);
            setTimeout(() => {
                newPost.classList.remove('new-post');
            }, 2000);

            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –Ω–∞ –Ω–æ–º–µ—Ä –ø–æ—Å—Ç–∞
            newPost.querySelector('.post-id a').addEventListener('click', function(e) {
                if (e.ctrlKey || e.metaKey) return;
                e.preventDefault();
                setReplyTo(postData.id);
            });
        }

        // –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function setReplyTo(postId) {
            document.getElementById('parent_id').value = postId;
            document.getElementById('reply-to-id').textContent = '>>' + postId;
            document.getElementById('reply-info').style.display = 'flex';
            document.getElementById('reply-form').scrollIntoView({ behavior: 'smooth' });
            document.querySelector('textarea[name="content"]').focus();
        }

        function clearReply() {
            document.getElementById('parent_id').value = '0';
            document.getElementById('reply-info').style.display = 'none';
        }

        // –ö–ª–∏–∫ –ø–æ –Ω–æ–º–µ—Ä—É –ø–æ—Å—Ç–∞
        document.querySelectorAll('.post-id a').forEach(link => {
            link.addEventListener('click', function(e) {
                if (e.ctrlKey || e.metaKey) return;
                e.preventDefault();
                const postId = this.textContent;
                setReplyTo(postId);
            });
        });

        // –ó–∞–ø—É—Å–∫ WebSocket –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        connectWebSocket();
    </script>
</body>
</html>
